<!doctype html>
<html><head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Praetorius Embed</title>
  <style>
    html,body{height:100%;margin:0}
    body{background:#0f0f0f;color:#fff;font:14px/1.4 ui-monospace,Menlo,Consolas,monospace}
    #app{position:fixed;inset:0}
    #err{position:fixed;left:12px;right:12px;bottom:12px;background:#111a;border:1px solid #333;padding:10px;border-radius:10px}
    code{background:#0003;padding:2px 4px;border-radius:6px}
  </style>
</head>
<body>
  <div id="app" aria-label="Praetorius host"></div>
  <div id="err" hidden></div>
  <script type="module">
  const q  = new URLSearchParams(location.search);
  const works = q.get('works') || 'samples/works.playground.json';
  const skin  = q.get('skin')  || 'typefolio';
  const pf    = q.get('pageFollow');
  const pageFollow = pf === null ? true : (pf === '1' || pf === 'true');
  const debug = q.get('debug') === '1';

  const baseDir = (() => {
    const path = location.pathname.replace(/\/[^/]*$/, '');
    if (!path || path === '/') return '';
    return path;
  })();
  const withBase = (path) => {
    if (!path) return baseDir;
    const normalized = path.startsWith('/') ? path : `/${path}`;
    return `${baseDir}${normalized}`;
  };

  const worker = withBase('/vendor/pdfjs/pdf.worker.min.js');
  const esmUrl = withBase('/prae-lib/praetorius.es.js');
  const umdUrl = withBase('/prae-lib/praetorius.umd.js');

  window.PDFJS_GLOBAL_WORKER_OPTIONS = { workerSrc: worker };

  function fail(msg, url, extra){
    const box = document.getElementById('err');
    box.hidden = false;
    box.innerHTML = `<strong>Embed failed:</strong> ${msg}${url ? `<br/><code>${url}</code>` : ''}`;
    if (debug && extra) {
      const pre = document.createElement('pre');
      pre.style.whiteSpace = 'pre-wrap';
      pre.textContent = JSON.stringify(extra, null, 2);
      box.appendChild(pre);
    }
  }

  const hasAPI = (x) => !!x && (typeof x.mount === 'function' || typeof x.init === 'function' || x.App);
  function unwrapAPI(x){
    if (!x) return null;
    if (hasAPI(x)) return x;
    if (hasAPI(x.default)) return x.default;
    if (x.default && hasAPI(x.default.default)) return x.default.default;
    if (typeof x === 'function') return { mount: x, init: x };
    if (typeof x?.default === 'function') return { mount: x.default, init: x.default };
    return null;
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Failed to load ' + src));
      document.head.appendChild(s);
    });
  }

  async function tryESM() {
    try {
      const mod = await import(new URL(esmUrl, location.href).toString());
      const api = unwrapAPI(mod) || unwrapAPI(mod?.PRAE);
      if (api) return api;
    } catch {}
    return null;
  }

  async function tryUMD() {
    // 1) Classic script path
    try {
      await loadScript(new URL(umdUrl, location.href).toString());
      const g = window;
      const candidates = [g.PRAE, g.PraetoriusPortfolio, g.Praetorius, g.praetorius, g.Prae];
      for (const c of candidates) {
        const api = unwrapAPI(c);
        if (api) return api;
      }
    } catch {}
    // 2) Fallback: import the same file as a module (covers mis-labeled ESM)
    try {
      const mod = await import(new URL(umdUrl, location.href).toString());
      const api = unwrapAPI(mod) || unwrapAPI(mod?.PRAE);
      if (api) return api;
    } catch {}
    return null;
  }

  async function mount(API) {
    const ping = await fetch(works, { cache: 'no-store' });
    if (!ping.ok) throw new Error(`Works JSON not found (${ping.status}) at ${new URL(works, location.href)}`);

    const host = document.getElementById('app');
    const opts = { worksUrl: works, skin, pageFollow, pdfWorkerSrc: worker, deepLinking: true };

    if (typeof API.mount === 'function')      return API.mount(host, opts);
    if (typeof API.init  === 'function')      return API.init(host, opts);
    if (API?.App)                              { const app = new API.App(opts); return app?.mount?.(host); }
    throw new Error('Unsupported PRAE API (no mount/init/App)');
  }

  (async () => {
    try {
      const API = await tryESM() || await tryUMD();
      if (!API) return fail('window.PRAE not found after ESM/UMD attempts', null, { tried: { esmUrl, umdUrl }});
      window.PRAE = API; // normalize
      await mount(API);
    } catch (e) { fail(e?.message || String(e)); }
  })();
</script>

</body></html>
