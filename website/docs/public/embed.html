<!doctype html>
<html><head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Praetorius Embed</title>
  <style>
    html,body{height:100%;margin:0}
    body{background:#0f0f0f;color:#fff;font:14px/1.4 ui-monospace,Menlo,Consolas,monospace}
    #app{position:fixed;inset:0}
    #err{position:fixed;left:12px;right:12px;bottom:12px;background:#111a;border:1px solid #333;padding:10px;border-radius:10px}
    code{background:#0003;padding:2px 4px;border-radius:6px}
  </style>
</head>
<body>
  <div id="app" aria-label="Praetorius host"></div>
  <div id="err" hidden></div>
  <script type="module">
  const q  = new URLSearchParams(location.search);
  const works = q.get('works') || 'samples/works.playground.json';
  const skin  = q.get('skin')  || 'typefolio';
  const pf    = q.get('pageFollow');
  const pageFollow = pf === null ? true : (pf === '1' || pf === 'true');

  const worker = 'vendor/pdfjs/pdf.worker.min.js';
  const esmUrl = 'vendor/prae/praetorius.es.js';
  const umdUrl = 'vendor/prae/praetorius.umd.js';

  // pdf.js worker must be a STRING URL
  window.PDFJS_GLOBAL_WORKER_OPTIONS = { workerSrc: worker };

  function fail(msg, url){
    const box = document.getElementById('err');
    box.hidden = false;
    box.innerHTML = `<strong>Embed failed:</strong> ${msg}${url ? `<br/><code>${url}</code>` : ''}`;
  }

  // Pick the real API surface (handles default-wrapped UMD/ESM)
  function pickAPI(x) {
    if (!x) return null;
    const has = (o) => o && (typeof o.mount === 'function' || typeof o.init === 'function' || o.App);
    if (has(x)) return x;
    if (has(x.default)) return x.default;
    // Some bundlers wrap one more layer (e.g., { default: { default: API }})
    if (x.default && has(x.default.default)) return x.default.default;
    return null;
  }

  async function tryESM() {
    try {
      const mod = await import(new URL(esmUrl, location.href).toString());
      const api = pickAPI(mod) || pickAPI(mod?.PRAE);
      if (api) { window.PRAE = api; return true; }
    } catch { /* no-op */ }
    return false;
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Failed to load ' + src));
      document.head.appendChild(s);
    });
  }

  async function tryUMD() {
    await loadScript(new URL(umdUrl, location.href).toString());
    const g = window;
    const candidates = [g.PRAE, g.PraetoriusPortfolio, g.Praetorius, g.praetorius];
    for (const c of candidates) {
      const api = pickAPI(c);
      if (api) { window.PRAE = api; return true; }
    }
    return false;
  }

  async function mount() {
    const PRAE = window.PRAE;
    if (!PRAE) throw new Error('PRAE API missing');

    // Probe works JSON so failures are explicit
    const ping = await fetch(works, { cache: 'no-store' });
    if (!ping.ok) throw new Error(`Works JSON not found (${ping.status}) at ${new URL(works, location.href)}`);

    const host = document.getElementById('app');
    const opts = { worksUrl: works, skin, pageFollow, pdfWorkerSrc: worker, deepLinking: true };

    if (typeof PRAE.mount === 'function')      await PRAE.mount(host, opts);
    else if (typeof PRAE.init  === 'function') await PRAE.init(host, opts);
    else if (PRAE?.App)                        { const app = new PRAE.App(opts); await app?.mount?.(host); }
    else throw new Error('Unsupported PRAE API (no mount/init/App)');
  }

  (async () => {
    try {
      const ok = await tryESM() || await tryUMD();
      if (!ok) throw new Error('window.PRAE not found after ESM and UMD attempts');
      await mount();
    } catch (e) {
      fail(e?.message || String(e));
    }
  })();
</script>
</body></html>
