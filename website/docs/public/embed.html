<!doctype html>
<html><head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Praetorius Embed</title>
  <style>
    html,body{height:100%;margin:0}
    body{background:#0f0f0f;color:#fff;font:14px/1.4 ui-monospace,Menlo,Consolas,monospace}
    #app{position:fixed;inset:0}
    #err{position:fixed;left:12px;right:12px;bottom:12px;background:#111a;border:1px solid #333;padding:10px;border-radius:10px}
    code{background:#0003;padding:2px 4px;border-radius:6px}
  </style>
</head>
<body>
  <div id="app" aria-label="Praetorius host"></div>
  <div id="err" hidden></div>
  <script type="module">
  const q  = new URLSearchParams(location.search);
  const works = q.get('works') || 'samples/works.playground.json';
  const skin  = q.get('skin')  || 'typefolio';
  const pf    = q.get('pageFollow');
  const pageFollow = pf === null ? true : (pf === '1' || pf === 'true');

  const worker = 'vendor/pdfjs/pdf.worker.min.js';
  const esmUrl = 'vendor/prae/praetorius.es.js';
  const umdUrl = 'vendor/prae/praetorius.umd.js';

  window.PDFJS_GLOBAL_WORKER_OPTIONS = { workerSrc: worker };

  function fail(msg, url){
    const box = document.getElementById('err');
    box.hidden = false;
    box.innerHTML = `<strong>Embed failed:</strong> ${msg}${url ? `<br/><code>${url}</code>` : ''}`;
  }

  async function preferESMThenUMD() {
    // Try ESM
    try {
      const mod = await import(new URL(esmUrl, location.href).toString());
      const candidate = mod?.default || mod?.PRAE || mod;
      if (candidate) return candidate;
    } catch {}
    // Fallback UMD
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = new URL(umdUrl, location.href).toString();
      s.async = true;
      s.onload = res;
      s.onerror = () => rej(new Error('Failed to load ' + umdUrl));
      document.head.appendChild(s);
    });
    const g = window;
    // Accept your former name too, and default-exported UMDs
    return g.PRAE || g.PraetoriusPortfolio || g.Praetorius || g.praetorius || (g.PRAE && g.PRAE.default);
  }

  (async () => {
    try {
      const API = await preferESMThenUMD();
      if (!API) throw new Error('window.PRAE not found after ESM/UMD attempts');

      // Normalize to window.PRAE for downstream scripts/tools.
      window.PRAE = API;

      // Probe works JSON so failures are explicit
      const ping = await fetch(works, { cache: 'no-store' });
      if (!ping.ok) throw new Error(`Works JSON not found (${ping.status}) at ${new URL(works, location.href)}`);

      const host = document.getElementById('app');
      const opts = { worksUrl: works, skin, pageFollow, pdfWorkerSrc: worker, deepLinking: true };

      if (typeof API.mount === 'function')      await API.mount(host, opts);
      else if (typeof API.init  === 'function') await API.init(host, opts);
      else if (API?.App)                        { const app = new API.App(opts); await app?.mount?.(host); }
      else throw new Error('Unsupported PRAE API (no mount/init/App)');
    } catch (e) {
      fail(e?.message || String(e));
    }
  })();
</script>
</body></html>
