<!-- ===== GROUP WRAPPER: Title • Console • Breadcrumbs (one-page fit) ===== -->
 <section id="works-group" class="wc-group" aria-label="Seb Suarez Works List" data-theme="dark" data-size="lg">
  <!-- Title (stacked, minimal, mono) -->
  <header id="works-title" class="wc-titlebar" aria-label="Page Title">
    <div class="wt-wrap">
<!-- Theme toggle -->
    <button id="wc-theme-toggle" class="wc-theme" type="button" aria-label="Toggle theme" title="Toggle theme">
      <!-- Sun (for switching to Light) -->
      <span class="wc-ico wc-ico-sun" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd" />
        </svg>
      </span>
      <!-- Moon (for switching to Dark) -->
      <span class="wc-ico wc-ico-moon" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
        </svg>
      </span>
    </button>
      <h1 class="wt-title">Seb Suarez, Works List</h1>
      <p class="wt-subtitle">
        Selected works with cues &amp; notes
        <span class="wt-updated" aria-label="Last updated">Updated&nbsp;Nov&nbsp;3</span>
      </p>
    </div>
  </header>


<!-- Works List — Single-Page CLI Console (AeroShell: translucent black + amber) -->
<section id="works-console" aria-label="Works List Console">
<div class="wc-split"> 
  <div class="wc-frame">
    <div class="wc-output" aria-live="polite"></div>
    <!-- HUD: sticky status + progress -->
    <div class="wc-hud" aria-live="polite" aria-atomic="true"></div>
    <form class="wc-input" autocomplete="off" spellcheck="false">
      <label class="wc-prompt" aria-hidden="true">$</label>
      <input id="wc-cmd" type="text" inputmode="latin" autocapitalize="off" autocomplete="off" />
    </form>
  </div>
<!-- Right PDF pane (split view; not a modal) -->
    <aside class="wc-pdfpane" aria-label="Score PDF" aria-hidden="true">
      <header class="wc-pdfbar">
        <button type="button" class="wc-pdf-close" aria-label="Close PDF">✕</button>
        <div class="wc-pdf-title" aria-live="polite"></div>
      </header>
      <iframe class="wc-pdf-frame" title="Score PDF" loading="lazy"
         allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    </aside>
  </div>

  <!-- Hidden native audio (lazy: src set on first play). If you keep Google Drive "view" links,
       the script will auto-rewrite them to direct "uc?export=download&id=..." streams. -->
  <audio id="wc-a1" preload="none" playsinline data-audio="https://cdn.jsdelivr.net/gh/cbassuarez/website-blog/audio/SSS_soundnoisemusic_audio.mp3"></audio>
  <audio id="wc-a2" preload="none" playsinline data-audio="https://cdn.jsdelivr.net/gh/cbassuarez/website-blog/audio/luxnova.mp3"></audio>
  <audio id="wc-a3" preload="none" playsinline data-audio="https://cdn.jsdelivr.net/gh/cbassuarez/website-blog/audio/amplifications.mp3"></audio>
</section>
<!-- PDF Overlay (in-page viewer) -->
<div id="wc-pdf" class="wc-pdf" hidden role="dialog" aria-modal="true" aria-label="Score PDF">
  <button type="button" class="wc-pdf-close" aria-label="Close PDF">✕</button>
  <iframe class="wc-pdf-frame" title="Score PDF" loading="lazy" allow="autoplay; fullscreen"></iframe>

</div>


 <script>
 (function(){
   try{
     var root  = document.getElementById('works-group');
     var saved = localStorage.getItem('wc.theme');
     // migrate old JSON {"mode":"dark"} → "dark"
     if(saved && saved.trim().charAt(0)==='{'){
       try { saved = (JSON.parse(saved)||{}).mode || 'dark'; } catch(_){ saved = 'dark'; }
     }
     var eff = (saved === 'light') ? 'light' : 'dark';
     root.removeAttribute('data-theme-mode');
     root.setAttribute('data-theme', eff);
     document.documentElement.style.colorScheme = 'light dark';
   }catch(e){}
 })();
 </script>

<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap');

  /* ===========================
     AeroShell — translucent black, amber accent
     =========================== */
  #works-console{
    --fg:#f3f4f6; --muted:#c7c8ce; --dim:#9aa1a9;
    --warn:#fbbf24; --err:#ef4444; --ok:#22c55e;
    --accent:#ffffff;                 /* amber */
    --aero-bg:rgba(0,0,0,.9);        /* BLACK, not gray */
    --aero-stroke:rgba(255,255,255,.02);
    --aero-blur:14px;
    --aero-shadow:0 30px 80px rgba(0,0,0,.55);
    --aero-glow:0 0 0 1px rgba(255,255,255,.05);
    --line:rgba(255,255,255,.08);
    --chip-bg:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    --chip-bd:rgba(255,255,255,.16);
    --chip-bg-h:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    --chip-ring:rgba(245,245,245,.38); /* amber ring */
    --radius:6px;                    /* 6px everywhere */
  }
  #works-console{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

  /* Frame: translucent glass, blur, deep shadow (6px corners) */
  #works-console .wc-frame{
    color:var(--fg);
    background:var(--aero-bg);
    border:1px solid var(--aero-stroke);
    border-radius:var(--radius);
    box-shadow:var(--aero-shadow), var(--aero-glow) inset;
    -webkit-backdrop-filter:saturate(120%) blur(var(--aero-blur));
            backdrop-filter:saturate(120%) blur(var(--aero-blur));
    max-width:1100px; margin:20px auto; overflow:hidden;
  }

  /* Output */
  #works-console .wc-output{
    padding:18px 18px 8px; min-height:260px; max-height:70vh; overflow:auto; line-height:1.52;
  }
  #works-console .divider{height:0px; background:var(--line); margin:0px 0; opacity:.9}

  /* Input row */
  #works-console .wc-input{
    display:flex; align-items:center; gap:10px; padding:10px 14px 14px;
    border-top:1px solid var(--line);
    background:
      radial-gradient(80% 90% at 0% 0%, rgba(255,255,255,.05), transparent 25%),
      radial-gradient(80% 90% at 100% 0%, rgba(255,255,255,.03), transparent 25%);
  }
  #works-console .wc-prompt{color:var(--accent); font-weight:700; user-select:none}
  #works-console #wc-cmd{flex:1; font:inherit; color:var(--fg); background:transparent; border:none; outline:none; caret-color:var(--accent)}

  /* Lines + animated reveal */
  #works-console .line{white-space:pre-wrap; word-break:break-word; opacity:0; transform:translateY(2px); transition:opacity .16s ease-out, transform .16s ease-out}
  #works-console .line.in{opacity:1; transform:none}
  #works-console .line.dim{color:var(--dim)}
  #works-console .line.muted{color:var(--muted)}
  #works-console .line.warn{color:var(--warn)}
  #works-console .line.err{color:var(--err)}
  #works-console .line.ok{color:var(--ok)}
  #works-console .title{color:var(--title-fg); font-weight:800; letter-spacing:.2px}
  #works-console .cmd-echo .prompt{color:var(--accent); font-weight:700}
  #works-console .sp{display:inline-block; width:.4em}

  /* Work blocks (12px) */
  #works-console .row{margin:2px 0 12px}
  #works-console .blk{
    padding:12px 12px; border:1px solid var(--line); border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    box-shadow:inset 0 1px rgba(255,255,255,.05);
  }
  #works-console .one{color:var(--muted)}

  /* Buttons (chips) — amber hover, 6px focus ring */
  #works-console .actions{margin-top:8px; display:flex; flex-wrap:wrap; gap:8px}
  #works-console .btn{
    position:relative; appearance:none; border:1px solid var(--chip-bd);
   background:var(--chip-bg); color:var(--btn-fg); border-radius:6px;
    padding:6px 6px; font:inherit; cursor:pointer; line-height:1.2;
    box-shadow:inset 0 1px rgba(255,255,255,.08), 0 1px 0 rgba(255,255,255,.03);
    transition:transform .12s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
  }
  #works-console .btn:hover{
    background:var(--chip-bg-h); transform:translateY(-1px);
    border-color:var(--border-hover); box-shadow:inset 0 1px rgba(255,255,255,.1), 0 0 6px rgba(245,158,11,.12);
  }
  #works-console .btn:active{transform:translateY(0)}
  #works-console .btn:focus-visible{outline:none; box-shadow:0 0 0 3px var(--chip-ring)}

  /* Scrollbar subtle */
  #works-console .wc-output::-webkit-scrollbar{height:10px;width:10px}
  #works-console .wc-output::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:10px}
  #works-console .wc-output::-webkit-scrollbar-track{background:transparent}

  /* Toast (6px) */
  #works-console .toast{
    position:sticky; bottom:6px; align-self:flex-start; margin-top:6px;
    display:inline-block; padding:6px 10px; border-radius:var(--radius);
    background:rgba(0,0,0,.65); border:1px solid var(--aero-stroke);
    -webkit-backdrop-filter:saturate(120%) blur(10px); backdrop-filter:saturate(120%) blur(10px);
    box-shadow:0 10px 30px rgba(0,0,0,.45);
    font-size:.92em; color:var(--warn);
    opacity:0; transform:translateY(4px); transition:opacity .18s ease, transform .18s ease;
  }
  #works-console .toast.in{opacity:1; transform:none}

  /* HUD: sticky status + progress (6px corners) */
  #works-console .wc-hud{
    position: sticky; bottom: 0; margin: 8px 6px 6px;
    padding: 8px 10px; border-radius: var(--radius);
    background: rgba(255,255,255,.04);
    border: 1px solid var(--line);
    box-shadow: inset 0 1px rgba(255,255,255,.06);
    font-variant-numeric: tabular-nums;
container-type: inline-size; /* enable container queries for responsive hiding */
 }
  }
/* Hide the HUD container until it has children */
  #works-console .wc-hud:empty{ display:none; }
   #works-console .wc-hud .row{display:flex; gap:10px; align-items:center; flex-wrap:nowrap; margin:0; white-space:nowrap}

  #works-console .wc-hud .tag{padding:2px 8px; border-radius:6px; border:1px solid var(--chip-bd); background:var(--chip-bg)}
/* Fixed-width “Now playing …” pill with marquee */
#works-console .wc-hud .tag-now{
  display:inline-block;
  max-width:100%;          /* safety */
  overflow:hidden;
  white-space:nowrap;
  vertical-align:middle;
}
#works-console .wc-hud .tag-now .scroll{
  display:inline-flex; align-items:center; gap:1.25em;
  will-change: transform;
}
#works-console .wc-hud .tag-now .txt,
#works-console .wc-hud .tag-now .dup{ white-space:nowrap; }
#works-console .wc-hud .tag-now.is-marquee .scroll{
  animation: wc-marquee 16s linear infinite;
}
@keyframes wc-marquee{
  from{ transform: translateX(0); }
  to  { transform: translateX(-50%); } /* two copies → slide by one copy width */
}
 #works-console .meter{position:relative; width:160px; height:6px; border-radius:6px; background:rgba(255,255,255,.10); overflow:hidden; flex:0 0 160px}
  #works-console .meter > span{position:absolute; inset:0 100% 0 0; background:linear-gradient(90deg, rgba(255,255,255,.75), rgba(255,255,255,.35)); border-radius:6px}
  #works-console .wc-hud .soft{color:var(--muted)}
/* HUD actions */
#works-console .hud-actions{margin-left:auto; display:flex; gap:8px; align-items:center}
#works-console .hud-btn{
  padding:6px 6px;         /* a bit more vertical padding */
  font-size:.92em;
  line-height:1.15;
  border-radius:6px;       /* ensure 6px */
}
/* HUD responsive: shrink then hide the progress bar to keep one line */
@container (max-width: 920px){
  #works-console .meter{ width:120px; flex-basis:120px; }
}
@container (max-width: 780px){
  #works-console .meter{ width:80px; flex-basis:80px; }
}
@container (max-width: 640px){
  #works-console .meter{ display:none; }
  #works-console .wc-hud .row{ gap:8px; } /* tighten spacing a touch */
}
@container (max-width: 520px){
  #works-console .wc-hud .row{ gap:6px; } /* smallest screens */
}

</style>

<script>
(() => {
  const SCOPE = document.getElementById('works-group') || document;
  const $ = (s, r = SCOPE) => r.querySelector(s);
  const out = $('#works-console .wc-output');
  const input = $('#wc-cmd');
  const form = $('#works-console .wc-input');

  /* ===========================
     Hard-coded works (inline)
     =========================== */
  const works = {

    1: {
      id: 1, slug: 'soundnoisemusic',
      title: 'WORK 1 — String Quartet No. 2 “SOUNDNOISEMUSIC”',
      one: 'A through-composed/indeterminate quartet that alternates fixed score, structured mischief, and noise permissions.',
      cues: [{ label:'@10:30', t: time('10:30') }],
      audioId: 'wc-a1',
      pdf: 'https://cdn.jsdelivr.net/gh/cbassuarez/website-blog/STRING%20QUARTET%20NO.%202%20_soundnoisemusic_%20-%20Score-min.pdf',
      openNote: [
      ' ',
              'Heard melodies are sweet, but those unheard',
'Are sweeter; therefore, ye soft pipes, play on;',
'Not to the sensual ear, but, more endeared,',
'Pipe to the spirit ditties of no tone:',
'John Keats, “Ode on a Grecian Urn,” lines 11-14',
' ',
'Every other performance, this piece is entirely improvised. Every other performance, the performers follow the through-composed score. Every other other performance, this piece is played at 80% intent and 50% rsentment. Every other other other performance, the members of this piece trade parts. Every 10 performanes, the members of the ensemble are playing a cruel joke on the composer and the audience. Every 12, the 5th page of every part is swapped for a page from one of J.S. Bach’s Sonatas or Partitas for Violin. On any performance where it is the ensemble’s second time performing that day, the music is to be read in retrograde inversion. Every peformance indoors must be done at double tempo. In the event that performers were not fed prior to performing, they may play noise whenever they may choose. If ███████████████████████████████████████, the piece should be played in near-complete darkness.',
' ',
'If you cannot tell the difference if you cannot beat ‘em join ‘em then does it even matter?'
      
      ]
    },
    2: {
      id: 2, slug: 'lux-nova',
      title: 'WORK 2 — Organum Quadruplum “Lux Nova”',
      one: 'A stained-glass acoustics study: bowed dalle-de-verre slab transduced into a ring of pianos—polyphony by distance rather than shared air.',
      cues: [{ label:'@7:45', t: time('7:45') }, { label:'@9:15', t: time('9:15') }],
      audioId: 'wc-a2',
      pdf: null,
      openNote: [
      ' ',
        'There is a special quality to the kind of light that stained glass emanates which I find fascinating. Unlike traditional art, stained glass is an entanglement of light and material: the art is not the light, nor the glass, but the way the light conditions the space beyond which it occupies (a material declaration reminiscent of Fichtian dialectics or medieval anagogy; a sum greater than its parts). In this sense, it is not reflecting light but conditioning it, giving light a quality that makes its invisibilities visible.',
        ' ',
        'Abbot Suger, in a historical reaffirmation of Gothic architecture, described this phenomenon – light passing through glass, which gives body and boundary to the invisible – as lux nova. Medieval builders saw themselves as material theologians: with the technological advancements of the Gothic period allowing for great windows, they could materialize theological truths through illuminatio, making light itself into an art that “corresponds” to celestial œuvres.',
        ' ',
        'At the center is a dalle de verre slab, mounted to approximate free-free boundary conditions: edge-untethered, supported at nodal points, so the plate speaks in families of modes. As the bow excites the glass (in a lineage that runs from Suger’s Saint-Denis and its program of lux nova to Le Corbusier’s Notre-Dame du Haut with its deep-set colored glazing to Richter’s pixelated Cologne Cathedral window), the bow draws breath, a sort of pneuma. These sounds are transmitted via transducer speakers to a ring of pianos which, even without hammer action, perform as a sort of telephoned organum: polyphony carried at a distance by transduction rather than shared air. In this way, the pianos act as armature and tracery, structures that bind.'
        ]
    },
    3: {
      id: 3, slug: 'amplifications-marimbaideefixe',
      title: 'WORK 3 — AMPLIFICATIONS I · MARIMBAideefixe',
      one: 'Two prepared pianos as resonators for a 5.0-octave marimba: sympathetic “ghost ensemble” via transduction.',
      cues: [{ label:'@5:49', t: time('5:49') }],
      audioId: 'wc-a3',
      pdf: 'https://cdn.jsdelivr.net/gh/cbassuarez/website-blog/AMPLIFICATIONS%201.%20MARIMBAideefixe.pdf',
      openNote: [
      ' ',
        'AMPLIFICATIONS – a series of improvised compositions, utilizing multiple pianos as resonating bodies to extend the sustain of various instruments. with various metal implements scattered throughout the piano bodies, the strings sympathetically reverberate along to the improvisatory sounds of each instrument, at times a whisper, at times a roar. microphones are placed inside the body of the piano capturing a large, harmonious reverberation, a ghostly chamber ensemble of one. credits released October 16, 2023 marimba, viola da gamba, music box, multiple percussion, desk bells, sebastian suarez-solis audio, sebastian suarez-solis photo, sebastian suarez-solis recorded at California Institute of the Arts on Oct. 13-15, 2023. ',
        ' ',
        'MARIMBAideefixe – 2 prepared pianos + 5.0 octave marimba with the marimba, i found that the pianos were quite receptive to many of the notes and harmonies i would play. even though the marimba is tuned to 442, or maybe because of it, notes would pop out and rattle metal discs and bells inside the piano, sometimes the same note, sometimes a more distant one. the marimba makes the pianos roar, swell to life, a sort of homunculus, a marionette. a bell swirls around inside the body of the piano, providing a rounded, tumbling ostinato. a ghostly chamber ensemble. i describe the track as an idée fixe as the main motivating phrase is such a focus of my playing. the piano seems to like it very well. a note about barlines: This piece is constructed in two voices which move independently. For this reason, barlines are modified to preserve the nature of the voices. You will see that, often, barlines do not match up until the end of a phrase. This might make more sense when listening to the recording. Visually, it aims to help the performer notice distance, silence, and the space between instances, where more traditional notation may not. The phrases played, though disjunct, are imitations of a baroque style, extemporized in a baroque fashion.'
      ]
    }
  };

// === PageFollow maps (printed page numbers) ===
// Tip: if you later want page 1 to start at audio 0:00 (for W1), set mediaOffsetSec to -30.
const pageFollowMaps = {
  soundnoisemusic: {
    pdfStartPage: 11,        // printed p.1 is PDF page 11
    mediaOffsetSec: 0,       // set to -30 if you want page 1 at t=0
    pageMap: [
      { at: '0:30', page: 1 },
      { at: '1:00', page: 2 },
      { at: '1:35', page: 3 },
      { at: '2:00', page: 4 },
      { at: '2:48', page: 5 },
      { at: '4:03', page: 6 },
      { at: '4:35', page: 7 },
      { at: '4:52', page: 8 },
      { at: '5:29', page: 9 },
      { at: '5:56', page: 10 },
      { at: '6:12', page: 11 },
      { at: '6:28', page: 12 },
      { at: '7:54', page: 13 },
      { at: '8:39', page: 14 },
 { at: '9:44', page: 15 },
      { at: '10:30', page: 16 }
    ]
  },
  'amplifications-marimbaideefixe': {
    pdfStartPage: 7,         // printed p.1 is PDF page 7
    mediaOffsetSec: 0,
    pageMap: [
      { at: '0:00', page: 1 },
      { at: '1:07', page: 2 },
      { at: '2:13', page: 3 },
      { at: '3:33', page: 4 },
      { at: '4:17', page: 5 },
      { at: '5:01', page: 6 },
      { at: '5:49', page: 7 },
      { at: '6:44', page: 8 },
      { at: '7:22', page: 9 },
      { at: '7:49', page: 10 },
      { at: '8:39', page: 11 },
      { at: '9:45', page: 12 },
      { at: '10:39', page: 13 },
      { at: '12:01', page: 14 },
      { at: '12:47', page: 15 },
      { at: '13:56', page: 16 },
      { at: '15:04', page: 17 },
      { at: '15:44', page: 18 },
      { at: '16:42', page: 19 },
      { at: '18:40', page: 20 }
    ]
  }
  // work 2 has no score → no entry needed
};


   const cmds = ['help','list','open','play','pause','stop','copy','goto','pdf','vol','speed','resume','share','unlock','clear','theme'];
 const aliases = { h:'help', ls:'list', o:'open', p:'play', pa:'pause', st:'stop', cp:'copy', g:'goto', v:'vol', sp:'speed', rs:'resume', sh:'share', ul:'unlock', cls:'clear', th:'theme' };

  const history = []; let hi = 0; let toastTimer = null;
let bootDone = false; // prevent auto-scroll during initial render


  const state = {
    last: { n:null, at:0 },
    vol: 1.0,
    rate: 1.0
  };

  /* Boot: banner + auto List (present/invoked) */
  banner();
  echo('list', true); list(true);
  focusInput();
// Re-align title since console column may expand
  requestAnimationFrame(alignTitleToConsole);
// Make sure we start at the top (production-safe)
requestAnimationFrame(()=>{ out.scrollTop = 0; });
window.addEventListener('load', ()=>{ out.scrollTop = 0; }, { once:true });


  /* ===== Input handling ===== */
 form.addEventListener('submit', (e) => {
  e.preventDefault();
  const raw = input.value.trim();
  if(!raw){ echo(''); input.value=''; return; }
  bootDone = true;            // <— add this line
  echo(raw, true);
  history.push(raw); hi = history.length;
  run(raw);
  input.value='';
});

  input.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp'){ if(hi>0){ hi--; input.value = history[hi]||''; placeCaretEnd(); e.preventDefault(); } }
    if(e.key === 'ArrowDown'){ if(hi<history.length){ hi++; input.value = history[hi]||''; placeCaretEnd(); e.preventDefault(); } }
    if(e.key === 'c' && e.ctrlKey){ appendLine('^C','muted',true); input.value=''; e.preventDefault(); }
    if(e.key === 'l' && e.ctrlKey){ clearOut(); banner(); echo('list', true); list(true); input.value=''; e.preventDefault(); }
    if(e.key === 'Tab'){
      e.preventDefault();
      const parts = input.value.trim().split(/\s+/);
      const first = parts[0] || '';
      const pool = Object.keys(aliases).concat(cmds);
      const matches = pool.filter(c => c.startsWith(first));
      if(matches.length===1){ parts[0] = canonical(matches[0]); input.value = parts.join(' ') + ' '; }
    }
  });

  /* Click-to-run actions */
  out.addEventListener('click', (e) => {
  const b = e.target.closest('button[data-cmd]');
  if(!b) return;
  bootDone = true;            // <— add this line
  const cmd = b.getAttribute('data-cmd');
  echo(cmd, true);
  run(cmd);
});


  /* ===== Command router ===== */
  function run(raw){
    const parts = raw.trim().split(/\s+/);
    let cmd = canonical(parts.shift()?.toLowerCase() || '');
    const args = parts;

    switch(cmd){
      case 'help': help(); break;
      case 'list': list(); break;
      case 'open': openWork(args[0]); break;
      case 'play': playCmd(args); break;
      case 'pause': pauseCmd(args[0]); break;
      case 'stop': stopCmd(args[0]); break;
      case 'copy': copyCmd(args.join(' ')); break;   // allow time
      case 'goto': gotoCmd(args.join(' ')); break;   // allow time
      case 'pdf':  pdfCmd(args[0]); break;
      case 'vol':  volCmd(args[0]); break;
      case 'speed': speedCmd(args[0]); break;
      case 'resume': resumeCmd(args[0]); break;
      case 'share': shareCmd(args[0], args[1]); break;
      case 'unlock': unlockCmd(); break;
      case 'theme': themeCmd(args); break;
      case 'clear': clearOut(); banner(); break;
      default:
        if(cmd){ appendLine(`error: unknown command "${cmd}"`,'err',true); }
        else { appendLine('', '', true); }
    }
  }
// ===== PageFollow engine =====
let pageFollow = { audio:null, slug:null, lastPrinted:null, _on:null };

// printed → actual PDF page (1-based) for a given slug and time
function computePdfPage(slug, tSec=0){
  const cfg = pageFollowMaps[slug];
  if(!cfg) return 1;
  const printed = printedPageForTime(cfg, tSec);
  return (cfg.pdfStartPage || 1) + (printed - 1) + (cfg.pdfDelta ?? 0);
}
function secFromMixed(v){
  if(typeof v === 'number') return v;
  return time(v); // you already have time(mm:ss|s) helper
}

function printedPageForTime(cfg, tSec){
  const T = (tSec || 0) + (cfg.mediaOffsetSec || 0);
  let current = cfg.pageMap[0]?.page ?? 1;
  for(const row of cfg.pageMap){
    const at = secFromMixed(row.at);
    if(T >= at) current = row.page;
    else break;
  }
  return current;
}

function detachPageFollow(){
  if(pageFollow.audio && pageFollow._on){
    pageFollow.audio.removeEventListener('timeupdate', pageFollow._on);
    pageFollow.audio.removeEventListener('seeking', pageFollow._on);
  }
  pageFollow = { audio:null, slug:null, lastPrinted:null, _on:null };
}

function attachPageFollow(slug, audio){
  detachPageFollow();
  const cfg = pageFollowMaps[slug];
  if(!cfg || !audio) return;

  const onTick = ()=>{
    const printed = printedPageForTime(cfg, audio.currentTime || 0);
    if(printed !== pageFollow.lastPrinted){
      pageFollow.lastPrinted = printed;
      const pdfPage = computePdfPage(slug, audio.currentTime || 0);
      try { console.debug('[pagefollow]', { slug, printed, pdfPage, t: (audio.currentTime|0) }); } catch {}      // Fire one simple event. Your PDF pane should listen for this:
      window.dispatchEvent(new CustomEvent('wc:pdf-goto', {
        detail: { slug, printedPage: printed, pdfPage }
      }));
    }
  };

  pageFollow = { audio, slug, lastPrinted:null, _on:onTick };
  audio.addEventListener('timeupdate', onTick, { passive:true });
  audio.addEventListener('seeking', onTick, { passive:true });
  onTick(); // initial sync
}

  /* ===== Commands ===== */
  function help(){
    section('Commands');
    smoothLines([
      'help                   Show this help',
      'list                   List the three works with actions',
      'open <n>               Print program note for work n',
      'play <n> [mm:ss|s]     Play work n at time (defaults to first cue)',
      'pause <n>              Pause work n',
      'stop <n>               Stop work n',
      'copy <n> [time]        Copy deep link (supports ?t=)',
      'goto <n> [time]        Jump to #work-n (supports ?t=)',
      'pdf <n>                Open PDF for work n (1 & 3 only)',
      'vol <0–100>            Set volume percent',
      'speed <0.5–2>          Set playback rate',
      'resume [n]             Resume last (or specific) work',
      'share <n> [time]       Share/copy deep link (supports ?t=)',
      'unlock                 One-shot autoplay unlock',
      'clear                  Clear console',
      '',
      'aliases: h, ls, o, p, pa, st, cp, g, v, sp, rs, sh, ul, cls'
    ], 'muted', 12);
  }

  function list(isBoot=false){
    section(' ');
    const rows = Object.values(works).map(w => {
      const row = document.createElement('div'); row.className='row';
      row.appendChild(block([
        bold(`[${w.id}] ${w.title}`),
        span(w.one,'one'),
        actRow([
          btn(`open ${w.id}`,'Open'),
          ...w.cues.map(c => btn(`play ${w.id} ${formatTime(c.t)}`, `Play ${c.label}`)),
          btn(`copy ${w.id}`,'Copy URL'),
          ...(w.pdf ? [btn(`pdf ${w.id}`,'PDF')] : [])
        ])
      ]));
      return row;
    });

    rows.forEach((r,i) => setTimeout(() => { out.appendChild(r); revealChildren(r); scrollBottom(); }, i*30));
    
  }

  function openWork(nRaw){
    const n = parseInt(nRaw,10);
    const w = works[n];
    if(!w){ return appendLine(`error: unknown work ${nRaw}`,'err',true); }
    section(w.title);
    w.openNote.forEach((p,i)=> setTimeout(()=> appendLine(p,'',true), i*18));
    const acts = actRow([
      ...w.cues.map(c => btn(`play ${w.id} ${formatTime(c.t)}`, `Play ${c.label}`)),
      btn(`copy ${w.id}`,'Copy URL'),
      ...(w.pdf ? [btn(`pdf ${w.id}`,'PDF')] : [])
    ]);
    out.appendChild(acts); reveal(acts); scrollBottom();
  }

  function playCmd(args){
    const n = parseInt(args[0],10);
    const w = works[n];
    if(!w){ return appendLine(`error: unknown work ${args[0]||''}`,'err',true); }
    const t = args[1] ? time(args[1]) : (w.cues[0]?.t ?? 0);
    if(t<0){ return appendLine(`error: invalid time "${args[1]||''}" (use mm:ss or seconds)`,'err',true); }

    const a = $('#'+w.audioId);
    if(!a) return appendLine('error: audio element missing','err',true);

    // Set source (normalize Google Drive "view" to direct "uc?export=download")
    if(!a.src){
      const raw = a.dataset.audio || '';
      const src = normalizeSrc(raw);
      if(!src){ return appendLine('warn: no audio source found','warn',true); }
      a.src = src; a.load();
    }

    // Ensure we seek after metadata is available
    const seekAndPlay = () => {
      try { a.currentTime = t; } catch(_) { /* will try after metadata */ }
      actuallyPlay(a, n, t);
    };

    if(a.readyState >= 1){ // HAVE_METADATA
      seekAndPlay();
    } else {
      const onMeta = () => { a.removeEventListener('loadedmetadata', onMeta); seekAndPlay(); };
      a.addEventListener('loadedmetadata', onMeta);
    }
  }

  function actuallyPlay(a, n, t){
    // Ensure no overlaps: stop any previous/other streams cold.
     if (typeof stopAllAudio === 'function') stopAllAudio(a);
    const p = a.play();
    if(p && typeof p.catch === 'function'){
      p.catch((err)=>{
        // Disambiguate: autoplay vs bad source
        const name = (err && err.name) || '';
        if(name === 'NotAllowedError'){
          appendLine('warn: autoplay blocked; press play once in the browser','warn',true);
          toast('Autoplay blocked — click any Play action once, then retry.');
        } else {
          const bad = mediaStatus(a);
          appendLine(`error: could not start playback (${bad})`,'err',true);
          if(isGoogleDrive(a.src)){
            appendLine('hint: Google Drive viewer links must be converted to direct "uc?export=download" links. This console auto-rewrites, but very large files may still require re-hosting.','muted',true);
          }
        }
      });
    }
    state.last = { n, at: t||0 };
    bindAudio(n);
  hudUpdate(n, a);
  attachPageFollow(works[n].slug, a);   // attach first so showPdfPane() can tick
  syncPdfPaneForWork(n);
    appendLine(`playing [${n}] at ${formatTime(t)} ▷`,'',true);
  }

  function pauseCmd(nRaw){
    const n = parseInt(nRaw,10);
    const w = works[n]; if(!w) return appendLine(`error: unknown work ${nRaw}`,'err',true);
    const a = $('#'+w.audioId);
    if(a && !a.paused){ a.pause(); state.last = { n, at: a.currentTime||0 }; hudUpdate(n,a); appendLine(`paused [${n}] at ${formatTime(a.currentTime|0)} ❚❚`,'',true); }
    else appendLine(`paused [${n}]`,'muted',true);
  }

  function stopCmd(nRaw){
    const n = parseInt(nRaw,10);
    const w = works[n]; if(!w) return appendLine(`error: unknown work ${nRaw}`,'err',true);
    const a = $('#'+w.audioId);
    if(a){ a.pause(); a.currentTime = 0; }
    state.last = { n, at: 0 };
    clearHud(); // hide HUD when unused
detachPageFollow();

    appendLine(`stopped [${n}] ⏹`,'',true);
  }

  function copyCmd(argLine){
    const parts = (argLine ?? '').toString().trim().split(/\s+/);
    const n = parseInt(parts[0]||'',10);
    const tRaw = parts[1];
    return copyWithTime(n, tRaw);
  }

  function gotoCmd(argLine){
    const parts = (argLine ?? '').toString().trim().split(/\s+/);
    const n = parseInt(parts[0]||'',10);
    if(!works[n]) return appendLine(`error: unknown work ${parts[0]||''}`,'err',true);
    const t = secOrTime(parts[1]);
    location.hash = `#work-${n}${t ? `?t=${t}` : ''}`;
    appendLine(`goto #work-${n}${t?`?t=${t}`:''}`,'ok',true);
  }

function pdfCmd(nRaw){
  const n = parseInt(nRaw,10);
  if(!nRaw){ return appendLine('error: pdf requires a work number (1 or 3)','err',true); }
  const w = works[n];
  if(!w){ return appendLine(`error: unknown work ${nRaw}`,'err',true); }
  if(!w.pdf){ return appendLine(`error: no PDF available for work ${n}`,'err',true); }
  showPdfPane(w.pdf, w.title || `Work ${n}`);
// If audio was already playing:
  //  • same work → do not restart
  //  • different work → switch to this work’s audio
  const { n: playingN } = getActiveAudioInfo();
  if (playingN != null){
    if (playingN !== n){
      playCmd([String(n)]);
    }
    // else: already playing this work → leave playback untouched
  }
  // If nothing was playing, do not start audio; pane opened to score p.1 already.
}
const worksConsole = document.getElementById('works-console');
const pdfPane   = worksConsole.querySelector('.wc-pdfpane');
const pdfTitle  = worksConsole.querySelector('.wc-pdf-title');
const pdfFrame  = worksConsole.querySelector('.wc-pdf-frame');
const pdfCloseB = worksConsole.querySelector('.wc-pdf-close');
// === PageFollow → PDF viewer wiring (split-pane iframe) ===
let pendingPdfGoto = null;
let currentPdfSlug = null;
let pdfViewerReady = false;

// Listen for page-follow events from the audio side
 window.addEventListener('wc:pdf-goto', (e) => {
   const { slug, pdfPage } = e.detail || {};
   if (!pdfFrame || !pdfPage) return;
   // If pane closed OR event slug doesn't match the currently loaded PDF, queue it
   if (!worksConsole.classList.contains('has-pdf') ||
      (slug && slug !== currentPdfSlug) ||
      !pdfViewerReady) {
     pendingPdfGoto = { slug, pdfPage };
     return;
   }
   gotoPdfPage(pdfPage);
 });

// Apply any queued page once the viewer has loaded
pdfFrame.addEventListener('load', () => {
   pdfViewerReady = true;
  if (pendingPdfGoto && (!pendingPdfGoto.slug || pendingPdfGoto.slug === currentPdfSlug)) {
     gotoPdfPage(pendingPdfGoto.pdfPage);
     pendingPdfGoto = null;
   }
 });

// Hash-based navigation that works cross-origin for PDF.js viewer
function gotoPdfPage(pageNum){
  const src = pdfFrame.src || '';
  // PDF.js viewer: update hash (#page=) to navigate without touching the parent scroll state
  if (/\/viewer\.html/i.test(src)) {
    const url  = new URL(src, location.href);
    const hash = new URLSearchParams(url.hash.replace(/^#/, ''));
    const curPage = Number(hash.get('page') || '1');
    const target  = Number(pageNum);
    if (curPage === target) return; // already there → no-op (prevents extra paints)
    hash.set('page', String(target));
    if (!hash.has('zoom')) hash.set('zoom','page-width');
    url.hash = '#' + hash.toString();
    pdfFrame.src = url.toString();   // hash-only change → fast navigate in PDF.js
  } else {
    // Non-PDF.js viewers (e.g., Drive preview) don’t expose a reliable page API cross-origin.
    // No-op here; see note below to force PDF.js for page-follow works.
  }
}


function showPdfPane(rawUrl, title){
  const url = normalizePdfUrl(rawUrl);
  const src = choosePdfViewer(url);
  pdfTitle.textContent = String(title || 'Score');
  const abs = /^https?:\/\//i.test(src) ? src : ('https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179/web/viewer.html?file=' + encodeURIComponent(src));

  // Decide the initial target page BEFORE loading the viewer
  // Prefer the work we’re opening; only use page-follow position if it’s the *same* work.
  let initPage = 1;
  const wForUrl = Object.values(works).find(w => w.pdf === rawUrl);
// Track which work’s PDF is (about to be) loaded
  currentPdfSlug = wForUrl ? wForUrl.slug : null;
  worksConsole.dataset.pdfSlug = currentPdfSlug || '';
  if (wForUrl && pageFollow?.slug === wForUrl.slug){
    // Same work as the actively playing one → land on its *current* score page
    initPage = computePdfPage(wForUrl.slug, pageFollow.audio?.currentTime || 0);
  } else if (wForUrl){
    // Different (or no) active audio → land on SCORE page 1 (printed p.1)
    initPage = computePdfPage(wForUrl.slug, 0);
  } else if (pageFollow?.slug){
    // Fallback
    initPage = computePdfPage(pageFollow.slug, pageFollow.audio?.currentTime || 0);
  }

  // Strip any existing hash and boot the viewer already on the intended page
  const base = abs.split('#')[0];
  pdfViewerReady = false;  // viewer will reload now
  pdfFrame.src = `${base}#page=${Math.max(1, initPage)}&zoom=page-width&toolbar=0`;

  worksConsole.classList.add('has-pdf');
  pdfPane.setAttribute('aria-hidden', 'false');

  // Keep typing focus on the CLI input
  focusInput();
  appendLine(`opening ${title}…`,'muted',true);
// Force a page-follow tick so updated pdfStartPage/pdfDelta apply now
  if (pageFollow && typeof pageFollow._on === 'function') {
    pageFollow.lastPrinted = null; // invalidate cache so next tick dispatches
    pageFollow._on();
  }
// Keep title/subtitle left edge aligned to console column
  kickAlign(8);
}

function hidePdfPane(){
  pdfPane.setAttribute('aria-hidden', 'true');
  worksConsole.classList.remove('has-pdf');
currentPdfSlug = null;
  delete worksConsole.dataset.pdfSlug;
// Re-align as the grid snaps back
  kickAlign(8);

  // Clear iframe after transition to free memory
  setTimeout(()=>{ pdfFrame.src = 'about:blank'; }, 160);

  // Return focus to CLI input; scrolling remains enabled
  focusInput();
}

// Keep the PDF pane aligned with the active work (if the pane is open).
function syncPdfPaneForWork(n){
const w = works[n];
  if (!w) return;
  const isOpen = worksConsole.classList.contains('has-pdf');
  if (!w.pdf){ hidePdfPane(); return; }
  const same = isOpen && currentPdfSlug === w.slug;
  if (!same){ showPdfPane(w.pdf, w.title || `Work ${n}`); }
  // else: keep current viewer; page-follow will drive page via wc:pdf-goto
}

// Close interactions
if(pdfCloseB){
  pdfCloseB.addEventListener('click', hidePdfPane);
  // ESC closes when pane is open
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && worksConsole.classList.contains('has-pdf')) hidePdfPane();
  }, {passive:true});
}
// Re-align when the PDF pane finishes its width/transform transition
pdfPane.addEventListener('transitionend', (e)=>{
  if (e.propertyName === 'width' || e.propertyName === 'max-width' || e.propertyName === 'transform' || e.propertyName === 'opacity'){
    kickAlign(4);
  }
}, {passive:true});

// Re-align whenever #works-console gains/loses the has-pdf class
new MutationObserver(()=> kickAlign(4))
  .observe(worksConsole, { attributes:true, attributeFilter:['class'] });


/* Reuse your previous helpers (keep or paste if you removed them) */
function choosePdfViewer(url){
  const m = url.match(/https?:\/\/(?:drive|docs)\.google\.com\/file\/d\/([^/]+)\//);
  if (m) {
    // Prefer PDF.js for page control:
    const direct = `https://drive.google.com/uc?export=download&id=${m[1]}`;
  return `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(direct)}#page=1&zoom=page-width&toolbar=0`;

  }
  const sameOrigin = url.startsWith(location.origin);
  const corsLikely = /^https?:\/\/([^\/]*\.)?(jsdelivr\.net|unpkg\.com|githubusercontent\.com|cloudflare-ipfs\.com|stagedevices\.com|dexdsl\.org|cbassuarez\.com)\//i.test(url);
  if (sameOrigin || corsLikely){
   return `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(url)}#page=1&zoom=page-width&toolbar=0`;



  }
  return `${url}#toolbar=1&view=FitH`;
}


function normalizePdfUrl(u){
  if(!u) return '';
  const m = u.match(/https?:\/\/(?:drive|docs)\.google\.com\/file\/d\/([^/]+)\//);
  if(m) return `https://drive.google.com/file/d/${m[1]}/view?usp=drivesdk`;
  return u;
}


  function volCmd(arg){
    const v = Math.max(0, Math.min(100, parseInt(arg ?? '100',10)));
    state.vol = v/100;
    Object.values(works).forEach(w=>{
      const a = document.getElementById(w.audioId); if(a) a.volume = state.vol;
    });
    appendLine(`volume ${v}%`,'ok',true);
    const lastA = state.last.n ? document.getElementById(works[state.last.n].audioId) : null;
    hudUpdate(state.last.n, lastA);
  }

  function speedCmd(arg){
    const r = Math.max(.5, Math.min(2, parseFloat(arg ?? '1')||1));
    state.rate = r;
    Object.values(works).forEach(w=>{
      const a = document.getElementById(w.audioId); if(a) a.playbackRate = state.rate;
    });
    appendLine(`speed ${r.toFixed(2)}x`,'ok',true);
    const lastA = state.last.n ? document.getElementById(works[state.last.n].audioId) : null;
    hudUpdate(state.last.n, lastA);
  }

  function resumeCmd(nRaw){
    const n = nRaw ? parseInt(nRaw,10) : (state.last.n || null);
    if(!n || !works[n]) return appendLine('error: nothing to resume','err',true);
    const at = state.last.at || 0;
    run(`play ${n} ${formatTime(at|0)}`);
  }

  function shareCmd(nRaw, tRaw){
    const n = parseInt(nRaw,10); if(!works[n]) return appendLine(`error: unknown work ${nRaw}`,'err',true);
    const t = secOrTime(tRaw);
    const url = deepUrl(n, t);
    if(navigator.share){
      navigator.share({title: works[n].title, url}).then(
        ()=> appendLine('shared','ok',true),
        ()=> appendLine(url,'muted',true)
      );
    } else {
      if(navigator.clipboard) navigator.clipboard.writeText(url);
      appendLine(url,'ok',true);
    }
  }

  function unlockCmd(){
    const targets = Object.values(works).map(w=>document.getElementById(w.audioId)).filter(Boolean);
    let ran = false;
    const doOne = (a)=> new Promise(res=>{
      const prevV = a.volume; a.volume = 0;
      const src = a.src || normalizeSrc(a.dataset.audio||''); if(!a.src && src){ a.src = src; a.load(); }
      a.play().then(()=>{ a.pause(); a.volume = prevV; res(); }).catch(()=>{ a.volume = prevV; res(); });
    });
    (async () => {
      for(const a of targets){ await doOne(a); ran = true; }
      appendLine(ran ? 'audio unlocked' : 'nothing to unlock','ok',true);
    })();
  }

  /* ===== UI helpers ===== */
  function banner(){
    section('Praetorius – Interactive Portfolio v0.1');
    appendLine('Click an action or type a command.','muted',true);
    appendLine('Type help for more options','muted',true);
    appendLine(' ','muted',true);

  }

  function echo(s, isCmd=false){
    const ln = document.createElement('div');
    ln.className = 'line cmd-echo';
    ln.innerHTML = `<span class="prompt" style="color:var(--accent);font-weight:700">$</span><span class="sp"></span>${escapeHtml(s)}`;
    out.appendChild(ln); reveal(ln); scrollBottom();
  }

  function section(titleText){
    divider();
    const ln = el('div','line title');
    ln.textContent = titleText;
    out.appendChild(ln); reveal(ln);
    divider();
  }

  function smoothLines(arr, cls='', step=10){
    arr.forEach((t,i)=> setTimeout(()=> appendLine(t,cls,true), i*step));
  }

  function appendLine(t, cls='', animate=false){
    const ln = el('div', 'line'+(cls?(' '+cls):''));
    ln.textContent = t;
    out.appendChild(ln);
    if(animate) reveal(ln);
    scrollBottom();
  }

  function divider(){ const d = el('div','divider'); out.appendChild(d); }

  function btn(cmd, label){
    const b = document.createElement('button');
    b.type='button'; b.className = 'btn';
    b.setAttribute('data-cmd', cmd);
    b.setAttribute('aria-label', `${label} (${cmd})`);
    b.textContent = label;
    return b;
  }

  function actRow(children){
    const r = el('div','actions');
    children.forEach(c => r.appendChild(c));
    return r;
  }

  function block(nodes){
    const b = el('div','blk');
    nodes.forEach(n => b.appendChild(n));
    return b;
  }

  function bold(text){
    const d = el('div','line');
    const s = document.createElement('span'); s.style.fontWeight='800'; s.textContent = text;
    d.appendChild(s);
    return d;
  }

  function span(text, cls){
    const d = el('div','line ' + (cls||'')); d.textContent = text; return d;
  }

  function el(tag, cls){ const n = document.createElement(tag); if(cls) n.className = cls; return n; }

  function reveal(node){ requestAnimationFrame(()=> node.classList.add('in')); }
  function revealChildren(node){ node.querySelectorAll('.line, .actions, .blk').forEach(n => reveal(n)); }

  function clearOut(){ out.innerHTML=''; }

  function time(s){
    if(s==null || s==='') return -1;
    if(/^\d+$/.test(s)) return parseInt(s,10);
    const m = String(s).match(/^(\d+):([0-5]?\d)$/);
    if(!m) return -1;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function formatTime(sec){ sec = Math.max(0, Math.floor(sec)); const m=Math.floor(sec/60), s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }
  function canonical(name){ if(!name) return ''; if(aliases[name]) return aliases[name]; return name; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch])); }
  function scrollBottom(force=false){
  if(!bootDone && !force) return; // don't jump to bottom until user interacts
  out.scrollTop = out.scrollHeight;
}

  function focusInput(){ $('#works-console').addEventListener('click', ()=> input.focus(), {capture:true}); input.focus(); }
  function placeCaretEnd(){ const v = input.value; input.value=''; input.value=v; }

  /* ===== Media helpers ===== */
// Stop every <audio> on the page except the one we’re about to play
  function stopAllAudio(exceptEl){
    const all = Array.from(document.querySelectorAll('audio'));
    for(const a of all){
      if(exceptEl && a === exceptEl) continue;
      try { a.pause(); a.currentTime = 0; } catch(_){}
    }
  }
function getActiveAudioInfo(){
  for (const w of Object.values(works)){
    const a = document.getElementById(w.audioId);
    if (a && !a.paused && !a.ended){
      return { n: w.id, audio: a };
    }
  }
  return { n: null, audio: null };
}

  function isGoogleDrive(u){ return /https?:\/\/(drive|docs)\.google\.com\/file\/d\//.test(u); }
  function normalizeSrc(u){
    if(!u) return '';
    // Convert "https://drive.google.com/file/d/<ID>/view" → "https://drive.google.com/uc?export=download&id=<ID>"
    const m = u.match(/https?:\/\/(?:drive|docs)\.google\.com\/file\/d\/([^/]+)\//);
    if(m) return `https://drive.google.com/uc?export=download&id=${m[1]}`;
    return u;
  }
  function mediaStatus(a){
    if(a.error){ return `media error ${a.error.code}`; }
    switch(a.networkState){
      case a.NETWORK_EMPTY: return 'no source';
      case a.NETWORK_IDLE: return 'network idle';
      case a.NETWORK_LOADING: return 'loading';
      case a.NETWORK_NO_SOURCE: return 'no compatible source';
    }
    return 'unknown';
  }
// First interaction enables auto-scroll
['keydown','pointerdown','wheel'].forEach(ev=>{
  document.addEventListener(ev, ()=> (bootDone = true), { once:true, passive:true });
});

  /* ===== HUD helpers ===== */
  const hudBox = document.querySelector('#works-console .wc-hud');
  if(hudBox){
    hudBox.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-hud="toggle"]');
      if(!btn) return;
      const n = state.last.n;
      if(!n || !works[n]){ appendLine('warn: nothing to control','warn',true); return; }
      const a = document.getElementById(works[n].audioId);
      // Toggle: pause if playing, resume if paused
      if(a && !a.paused){
        run(`pause ${n}`);
      } else {
        run(`resume ${n}`);
      }
    });
  }

  /* Build HUD DOM once; just update text/progress later */
  let hudRefs = null;
  function ensureHudDom(){
    if(!hudBox) return null;
    if(hudRefs) return hudRefs;
    hudBox.innerHTML = '';
    const wrap  = document.createElement('div'); wrap.className = 'row';
    // Single pill with marquee text
    const tag   = document.createElement('span');
    tag.className = 'tag tag-now';
    const tagScroll = document.createElement('span'); tagScroll.className = 'scroll';
    const tagTxt    = document.createElement('span'); tagTxt.className = 'txt';
    const tagDup    = document.createElement('span'); tagDup.className = 'dup'; tagDup.setAttribute('aria-hidden','true');
    tagScroll.append(tagTxt, tagDup); tag.appendChild(tagScroll);
    const time  = document.createElement('span'); time.className = 'hud-time';
    const pipe  = document.createElement('span'); pipe.textContent = '|';
    const vol   = document.createElement('span'); vol.className = 'soft hud-vol';
    const speed = document.createElement('span'); speed.className = 'soft hud-speed';
    const meter = document.createElement('div'); meter.className = 'meter'; meter.setAttribute('aria-hidden','true');
    const fill  = document.createElement('span'); meter.appendChild(fill);
    const actions = document.createElement('div'); actions.className = 'hud-actions';
    const btn   = document.createElement('button');
    btn.type = 'button'; btn.className = 'btn hud-btn'; btn.setAttribute('data-hud','toggle');
    actions.appendChild(btn);
    wrap.append(tag, time, pipe, vol, speed, meter, actions);
    hudBox.appendChild(wrap);
    hudRefs = { tag, tagTxt, tagDup, time, vol, speed, fill, btn };
    // Lock pill width to current “Now Playing” size so it doesn’t grow/shrink with titles
    // (measure after it’s in the DOM)
    requestAnimationFrame(()=>{ if (!tag.style.width) tag.style.width = tag.offsetWidth + 'px'; });
    return hudRefs;
  }

  function hudUpdate(n, a){
    if(!hudBox) return;
    const refs = ensureHudDom(); if(!refs) return;
const wTitle = (n && works[n] ? works[n].title : '—');
    const pillText = `Now playing ${wTitle}`;
    // Update marquee text and duplicate for seamless loop
    refs.tagTxt.textContent = pillText;
    refs.tagDup.textContent = ' · ' + pillText;
    // Toggle marquee only if content overflows the fixed pill width
    // (use scrollWidth of the inner scroller vs the container width)
    const needsMarq = refs.tagScroll
      ? (refs.tagScroll.scrollWidth > refs.tag.clientWidth + 2)
      : (refs.tag.querySelector('.scroll').scrollWidth > refs.tag.clientWidth + 2);
    const tagEl = refs.tag;
    tagEl.classList.toggle('is-marquee', needsMarq);
    const dur = Number.isFinite(a?.duration) ? formatTime(a.duration|0) : '--:--';
    const cur = Number.isFinite(a?.currentTime) ? formatTime(a.currentTime|0) : '0:00';
    const pct = (a && a.duration) ? Math.max(0,Math.min(100,(a.currentTime/a.duration)*100)) : 0;
    refs.time.textContent  = `${cur} / ${dur}`;
    refs.vol.textContent   = `vol:${Math.round(state.vol*100)}`;
    refs.speed.textContent = `speed:${state.rate.toFixed(2)}x`;
    refs.fill.style.inset  = `0 ${100-pct}% 0 0`;  // keep your meter style
    refs.btn.textContent   = a?.paused ? 'Play ▷' : 'Pause ❚❚';
    refs.btn.setAttribute('aria-label', `${a?.paused ? 'Play' : 'Pause'} current track`);
  }
function clearHud(){
    if(!hudBox) return;
    hudBox.innerHTML = '';
    hudRefs = null;
  }

  function bindAudio(n){
    const w = works[n]; if(!w) return;
    const a = document.getElementById(w.audioId); if(!a) return;
    a.volume = state.vol; a.playbackRate = state.rate;
    if(!a.dataset.bound){
      a.addEventListener('timeupdate', ()=> hudUpdate(n,a), {passive:true});
      a.addEventListener('ratechange', ()=> hudUpdate(n,a), {passive:true});
      a.addEventListener('volumechange', ()=> hudUpdate(n,a), {passive:true});
      a.addEventListener('loadedmetadata', ()=> hudUpdate(n,a), {once:true, passive:true});
      a.addEventListener('ended', ()=> { hudUpdate(n,a); }, {passive:true});
      a.dataset.bound = '1';
    }
  }

  function pct(x){ return Math.max(0,Math.min(1, x)); }
  function secOrTime(s){ return (/^\d+(:[0-5]?\d)?$/.test(s||'')) ? time(s) : null; }
  function deepUrl(n, tSec){
    const base = `${location.origin}${location.pathname}#work-${n}`;
    return tSec ? `${base}?t=${tSec|0}` : base;
  }
  function copyWithTime(n, tRaw){
    const w = works[n]; if(!w) return appendLine(`error: unknown work ${n}`,'err',true);
    const t = secOrTime(tRaw);
    const url = deepUrl(n, t);
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(url).then(() => appendLine(`copied ${url}`,'ok',true),
        () => appendLine(url,'muted',true));
    } else {
      appendLine(url,'muted',true);
    }
  }

  /* Tiny toast (for autoplay or hints) */
  function toast(text, ms=2600){
    let t = $('.toast', out);
    if(!t){ t = document.createElement('div'); t.className='toast'; out.appendChild(t); }
    t.textContent = text; reveal(t);
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.classList.remove('in'), ms);
  }

  // Deep-link hint (+ time; no auto-exec)
  if(location.hash && /^#work-(\d+)(\?t=(\d+))?$/.test(location.hash)){
    const m = location.hash.match(/^#work-(\d+)(?:\?t=(\d+))?$/);
    const n = parseInt(m[1],10), t = m[2] ? parseInt(m[2],10) : null;
    
  }
  /* ===== Theme management (UI + CLI) — Light/Dark only (no Auto) ===== */
  const themeRoot = document.getElementById('works-group');
  const themeBtn  = document.getElementById('wc-theme-toggle');

  function readTheme(){
    try{
      const v = localStorage.getItem('wc.theme') || 'dark';
      return (v.trim().charAt(0)==='{') ? ((JSON.parse(v)||{}).mode || 'dark') : v; // migrate JSON → string
    }catch(_){ return 'dark'; }
  }
  function writeTheme(v){
    try{ localStorage.setItem('wc.theme', (v==='light' ? 'light' : 'dark')); }catch(_){}
  }
  function applyTheme(mode){
    const eff = (mode==='light') ? 'light' : (mode==='dark' ? 'dark' : readTheme());
    themeRoot.removeAttribute('data-theme-mode');
    themeRoot.setAttribute('data-theme', eff);
    if(themeBtn){
      themeBtn.setAttribute('title', `Toggle theme (Alt/Opt+D) · current: ${eff}`);
      themeBtn.setAttribute('aria-checked', String(eff==='dark'));
    }
    writeTheme(eff);
  }
  function cycleTheme(){
    const cur  = themeRoot.getAttribute('data-theme') || readTheme();
    const next = (cur === 'dark') ? 'light' : 'dark';
    applyTheme(next);
    appendLine(`theme ${next}`,'ok',true);
  }
  function themeCmd(args){
    const sub = (args[0]||'').toLowerCase();
    if(sub==='dark' || sub==='light'){ applyTheme(sub); appendLine(`theme ${sub}`,'ok',true); }
    else { appendLine('usage: theme dark|light','muted',true); }
  }
  if(themeBtn){ themeBtn.addEventListener('click', cycleTheme, {passive:true}); }
  document.addEventListener('keydown', (e)=>{
    if((e.altKey||e.metaKey) && (e.key==='d' || e.key==='D')){ e.preventDefault(); cycleTheme(); }
  }, {passive:false});
  applyTheme(readTheme());
/* ===== Align title/subtitle left edge with console column ===== */
  const titleWrap = document.querySelector('#works-title .wt-wrap');
  const groupRoot = document.getElementById('works-group');
  function alignTitleToConsole(){
    const frame = document.querySelector('#works-console .wc-frame');
    if(!titleWrap || !groupRoot || !frame) return;
    const gr = groupRoot.getBoundingClientRect();
    const fr = frame.getBoundingClientRect();
    const left = Math.max(0, Math.round(fr.left - gr.left));
    titleWrap.style.marginLeft = left + 'px';
    titleWrap.style.marginRight = '0';
    titleWrap.style.width = Math.round(fr.width) + 'px';
  }
  // Burst re-align (handles CSS transitions & async layout)
  function kickAlign(pulses = 6){
    let i = 0;
    const tick = () => { alignTitleToConsole(); if(++i < pulses) requestAnimationFrame(tick); };
    requestAnimationFrame(tick);
  }

  // Initial + responsive hooks
  window.addEventListener('load', alignTitleToConsole, { once:true });
  window.addEventListener('resize', alignTitleToConsole, { passive:true });
  try{
    const ro = new ResizeObserver(()=> kickAlign(2));
    const split = document.querySelector('#works-console .wc-split');
    const frame = document.querySelector('#works-console .wc-frame');
    if (split) ro.observe(split);
    if (frame) ro.observe(frame);
  }catch(_){}

})();
</script>
  <!-- ↑↑↑ KEEP YOUR EXISTING CONSOLE BLOCK VERBATIM HERE ↑↑↑ -->
  <!-- Breadcrumbs (inline, transparent, bottom) -->
  <nav id="works-breadcrumbs" class="wc-crumbs" aria-label="Breadcrumb">
  <div class="wb-wrap" role="group" aria-label="Navigation and meta">
    <!-- SVG orbit: hover-only spin; subtle; inline, no canvas -->
   <div class="wb-brand">
      <svg class="wb-orbit" viewBox="0 0 64 64" width="32" height="32" aria-hidden="true" focusable="false">
        <g class="iris-rot" stroke="#0f0f0f" stroke-width="1.4" fill="none"
           stroke-linecap="round" stroke-linejoin="round" vector-effect="non-scaling-stroke">
          <circle class="iris-ring" cx="32" cy="32" r="20"/>
          <circle class="iris-pupil" cx="32" cy="32" r="5"/>
          <g class="iris-blades" shape-rendering="geometricPrecision">
            <path class="blade" d="M32 18 C38 23, 42 27, 44 32"/>
            <path class="blade" d="M32 18 C38 23, 42 27, 44 32" transform="rotate(60 32 32)"/>
            <path class="blade" d="M32 18 C38 23, 42 27, 44 32" transform="rotate(120 32 32)"/>
            <path class="blade" d="M32 18 C38 23, 42 27, 44 32" transform="rotate(180 32 32)"/>
            <path class="blade" d="M32 18 C38 23, 42 27, 44 32" transform="rotate(240 32 32)"/>
            <path class="blade" d="M32 18 C38 23, 42 27, 44 32" transform="rotate(300 32 32)"/>
          </g>
        </g>
      </svg>
      <a class="wb-badge" href="https://github.com/cbassuarez/Praetorius_Interactive_Portfolio" target="_blank" rel="noopener">
        <img
          src="https://img.shields.io/badge/build-Praetorius%20%E2%80%93%20Interactive%20Portfolio-gray?style=flat&label=v0.1&labelColor=black&color=white"
          alt="v0.1 build — Praetorius Interactive Portfolio">
      </a>
    </div>

    <!-- Chip buttons (no delimiters) -->
    <div class="wb-actions">
      <a class="wb-chip" href="https://cbassuarez.com">More info</a>
      <a class="wb-chip" href="https://dexdsl.org">dex</a>
      <a class="wb-chip" href="https://stagedevices.com">Stage Devices</a>
    </div>

    <!-- Minimal microcopy -->
    <small class="wb-micro">© Seb&nbsp;Suarez 2025</small>
  </div>
</nav>

</section>
<style>
/* ===== One-page fit: Title • Console • Breadcrumbs ===== */
html, body { height:100%; overflow:hidden; } /* keep page from scrolling */
#works-group { overflow-x: clip; }
#works-group.wc-group{
  display:grid; grid-template-rows:auto 1fr auto;
  height:100dvh; min-height:100svh; overflow:hidden;
  padding:clamp(8px, 1.6vw, 16px);
  box-sizing:border-box;
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}

/* Make sure the console inherits IBM Plex Mono */
#works-console{ font-family: inherit !important; }
/* Console banner/title color token (overridden per theme below) */
#works-console{ --title-fg:#fff; }

/* Flex the console frame so output fills available space (no 70vh push) */
#works-console .wc-frame{ display:flex; flex-direction:column; margin:clamp(8px,1.5vh,20px) auto; }
/* In split view, zero the vertical margin so both columns align at the top */
#works-console .wc-split > .wc-frame{ margin:0 auto !important; }
#works-console .wc-split > .wc-pdfpane{ margin:0 !important; }
#works-console .wc-output{ flex:1 1 auto; max-height:none; }  /* override 70vh */

/* Titlebar */
.wc-titlebar{ position:relative; top:0; padding:4px 6px 8px; background:transparent; }
.wc-titlebar .wt-wrap{ max-width:1100px; margin:0 auto; color:#f3f4f6; opacity:1; transform:none; } /* default visible */
.wc-titlebar .wt-title{ margin:0; font-weight:700; letter-spacing:.2px; font-size:clamp(18px,2.3vw,28px); line-height:1.15; }
.wc-titlebar .wt-subtitle{ margin:.15em 0 0; color:#c7c8ce; font-weight:400; font-size:clamp(6px,1.4vw,16px); display:flex; gap:.6em; align-items:baseline; flex-wrap:wrap; }
.wc-titlebar .wt-updated{
  display:inline-flex; align-items:center; gap:.4em;
  padding:.15em .55em; border-radius:6px;
  border:1px solid rgba(255,255,255,.16);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  color:#fbbf24;
}
/* Theme toggle: top-right, safe-area aware */
.wc-titlebar .wt-wrap{ position:relative; }
#wc-theme-toggle.wc-theme{
  position:absolute; top:0; right:max(0px, env(safe-area-inset-right));
  display:inline-grid; place-items:center;
  width:36px; height:36px; border-radius:6px;
  border:1px solid rgba(0,0,0,.18);
  background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
  color:#0f0f0f; cursor:pointer; padding:0; line-height:1; z-index:2;
  transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
}
#wc-theme-toggle.wc-theme:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.12); }
#wc-theme-toggle svg{ width:20px; height:20px; display:block; }
/* Show the *target* icon: if currently dark, show Sun (switch to light); if light, show Moon */
#works-group[data-theme="dark"]  .wc-ico-moon{ display:none; }
#works-group[data-theme="light"] .wc-ico-sun{  display:none; }
/* Breadcrumbs pinned inside the group bottom */
.wc-crumbs{ align-self:end; background:transparent; padding:8px 6px 2px; }
.wc-crumbs .wb-list{ max-width:1100px; margin:0 auto; padding:0; list-style:none; display:flex; align-items:center; gap:.6em; flex-wrap:wrap; }
.wc-crumbs .wb-item{ display:flex; align-items:center; }
.wc-crumbs .wb-sep{ color:rgba(255,255,255,.45); }
.wc-crumbs .wb-link{
  display:inline-flex; align-items:center; gap:.45em;
  color:#f3f4f6; text-decoration:none; position:relative; padding:.1em .25em;
}
.wc-crumbs .wb-link::after{
  content:""; position:absolute; left:.25em; right:.25em; bottom:0;
  height:1px; background:linear-gradient(90deg, rgba(255,255,255,.7), rgba(255,255,255,.3));
  transform:scaleX(0); transform-origin:left; transition:transform .22s ease;
}
.wc-crumbs .wb-link:hover::after{ transform:scaleX(1); }
.wc-crumbs .wb-txt{ font-size:clamp(6px,1.3vw,15px); }

/* Safety on very short viewports */
@media (max-height:600px){
  #works-console .wc-hud{ position:static; margin-top:8px; }
}
/* Title: readable on white, compact */
.wc-titlebar{ padding: 2px 0 6px; background: transparent; }
.wc-titlebar .wt-wrap{ 
  max-width:1100px; margin:0 auto;
  color:#000000;                 /* dark text for white bg */
  opacity:1; transform:none;
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}
.wc-titlebar .wt-title{
  margin:0; font-weight:700; letter-spacing:.2px;
  font-size:clamp(16px, 1.9vw, 22px);  /* tighter */
  line-height:1.15;
font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

}
.wc-titlebar .wt-subtitle{
  margin:.2em 0 0; color:#475569;      /* slate-ish */
  font-weight:400; 
  font-size:clamp(11px, 1.2vw, 14px);  /* smaller */
  display:flex; gap:.6em; align-items:baseline; flex-wrap:wrap;
}
.wc-titlebar .wt-updated{
  display:inline-flex; align-items:center; gap:.4em;
  padding:.05em .45em; border-radius:6px;
  border:1px solid rgba(0,0,0,.12);     /* subtle on white */
  background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  color:#b45309;                        /* amber-ish text */
}
/* Shrink the console height (cap it) */
#works-console .wc-split{
  height: clamp(560px, 70vh, 1200px);     /* drives equal column height */
}
#works-console .wc-frame{
  height: 100% !important;                /* match split container */
  min-height: 120px !important;
  max-height: none !important;
  display: flex; flex-direction: column;
height: 100%;    
}
#works-console .wc-output{
  flex: 1 1 auto !important;
  min-height: 0 !important;
  max-height: none !important;
}
/* ——— Titlebar: force display, font, pure black ——— */
#works-group .wc-titlebar{
  display:block !important;
  position:relative;
  z-index:1;
  background:transparent;
  padding: 2px 0 6px;
font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}
#works-group .wc-titlebar .wt-wrap{
  max-width:1100px; margin:0 auto;
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace !important;
  color:#000000 !important;
}
#works-group .wc-titlebar .wt-title{
  margin:0;
  color:#000000 !important;
  font-weight:700;
  letter-spacing:.01em;
  font-size:clamp(18px, 1.8vw, 22px);
  line-height:1.15;
font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

}
#works-group .wc-titlebar .wt-subtitle{
  margin:.2em 0 0;
  color:#000000 !important;  /* minimal, pure black per spec */
  font-weight:400;
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

  font-size:clamp(11px, 1.2vw, 14px);
  display:flex; gap:.6em; align-items:baseline; flex-wrap:wrap;
}
#works-group .wc-titlebar .wt-updated{
  display:inline-flex; align-items:center; gap:.4em;
  padding:.05em .45em; border-radius:6px;
  border:1px solid rgba(0,0,0,.12);
  background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  color:#000000; /* keep black, still minimal on white */
font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}
/* ===== Bottom: Orbit + Chips (64px row) ===== */
.wc-crumbs{
  align-self:end;
  background:transparent;
  min-height:64px; height:64px; /* fixed target */
  display:flex; align-items:center; justify-content:center;
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  color:#0f0f0f;
  padding:4px 6px;
}
.wc-crumbs .wb-wrap{
  width:100%; max-width:1100px;
  display:grid; grid-template-columns:auto 1fr auto;
  gap:6px; align-items:center;
  margin:0 auto;
}



/* Chip buttons */
.wc-crumbs .wb-actions{ display:flex; gap:10px; justify-content:center; align-items:center; }
.wc-crumbs .wb-chip{
  display:inline-flex; align-items:center; justify-content:center;
  padding:8px 14px; border-radius:6px;
  border:1px solid var(--border-ctl);
  background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  text-decoration:none; color:#0f0f0f;
  font-size:clamp(6px,1.2vw,14px); line-height:1; letter-spacing:.005em;
  position:relative; transition:letter-spacing .2s ease, transform .15s ease, border-color .2s ease, background .2s ease;
}
.wc-crumbs .wb-chip::after{
  content:""; position:absolute; left:10px; right:10px; bottom:6px; height:1px;
  background:linear-gradient(90deg, rgba(0,0,0,.7), rgba(0,0,0,.35));
  transform:scaleX(0); transform-origin:left; transition:transform .22s ease;
}
.wc-crumbs .wb-chip:hover{ letter-spacing:.03em; transform:translateY(-1px); border-color:var(--border-hover); }
.wc-crumbs .wb-chip:hover::after{ transform:scaleX(1); }

/* Microcopy (right) */
.wc-crumbs .wb-micro{
  color:#0f0f0f; opacity:.65; font-size:clamp(11px,1.05vw,13px);
  user-select:none; white-space:nowrap;
}

/* ——— Aperture Iris (hover-only, subtle) ——— */
.wc-crumbs .wb-orbit{ width:32px; height:32px; display:block; }
.wc-crumbs .wb-orbit .iris-rot{ transform-origin:32px 32px; }
.wc-crumbs .wb-orbit .iris-pupil{
  transform-origin:32px 32px;
  transition: transform .35s ease;
}
.wc-crumbs .wb-orbit .blade{
  stroke-dasharray:4 8;
}

/* Hover animations: micro-rotation + dash shimmer + slight pupil dilation */
.wc-crumbs:hover .wb-orbit .iris-rot{ animation: iris-tilt 2.6s ease-in-out infinite; }
.wc-crumbs:hover .wb-orbit .blade{ animation: iris-dash 1.8s linear infinite; }
.wc-crumbs:hover .wb-orbit .iris-pupil{ transform: scale(1.12); }

@keyframes iris-tilt{
  0%{   transform: rotate(-6deg); }
  50%{  transform: rotate(6deg);  }
  100%{ transform: rotate(-6deg); }
}
@keyframes iris-dash{
  to { stroke-dashoffset: -20; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .wc-crumbs:hover .wb-orbit .iris-rot,
  .wc-crumbs:hover .wb-orbit .blade,
  .wc-crumbs:hover .wb-orbit .iris-pupil{
    animation:none !important;
    transform:none !important;
  }
}

/* Right PDF pane */
#works-console .wc-pdfpane{
  position: relative;
  border: 1px solid var(--border-ctl);
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 30px 80px rgba(0,0,0,.12);

  /* slide-in animation */
overflow: hidden;
  display:flex; flex-direction:column;   /* bar + iframe stack */
  min-height:0;                          /* allow children to size */
  transform: translateX(12px);
  opacity: 0;
  pointer-events: none;
  transition: transform .22s ease, opacity .22s ease;
}

/* Activate pane when split is on */
#works-console.has-pdf .wc-pdfpane{
  transform: translateX(0);
  opacity: 1;
  pointer-events: auto;
}

/* PDF top bar */
#works-console .wc-pdfbar{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; border-bottom:1px solid var(--border-ctl);
  background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}
#works-console .wc-pdf-title{
   font-size: clamp(14px, 1.6vw, 18px);
   line-height: 1.2;
   letter-spacing: .01em;
   color:#0f0f0f; opacity:.9;
   white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
   flex: 1 1 auto; min-width: 0; /* let it claim space and keep ellipsis */
}
#works-console .wc-pdf-title{ font-weight: 600; }
#works-console .wc-pdf-close{
  margin-left:auto;
  appearance:none; border:1px solid var(--border-ctl);
  background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.015));
  color:#0f0f0f; padding:6px 10px; border-radius:10px; cursor:pointer; line-height:1;
}

/* PDF iframe fills the pane */
#works-console .wc-pdf-frame{
  display:block; width:100%;
  flex: 1 1 auto;                          /* fill remaining height */
  height: auto !important;                 /* override calc() */
  border:0; background:#fff;
}

/* Keep console frame flexible (unchanged intent) */
#works-console .wc-frame{
  display:flex; flex-direction:column;
}

/* Mobile: pane overlays the console (still only within middle section) */
@media (max-width: 900px){
  #works-console.has-pdf .wc-split{
    grid-template-columns: 1fr;   /* keep one column */
    position: relative;
  }
  #works-console .wc-pdfpane{
    position:absolute; inset:0 0 0 auto; width: min(92vw, 720px);
    border-left: 1px solid rgba(0,0,0,.12);
    border-top-left-radius: 6px; border-bottom-left-radius: 6px;
    box-shadow: -24px 0 60px rgba(0,0,0,.18);
    transform: translateX(6%);
  }
}

/* Page grid: header • middle • footer */
#works-group.wc-group{
  /* was: grid-template-rows: auto 1fr auto; */
  grid-template-rows: auto minmax(0,1fr) auto;  /* <-- prevents middle from forcing overflow */
}

/* Let the middle section be shrinkable within its grid row */
#works-console{
  min-height: 0;   /* <-- critical so its internal overflow doesn't hide the footer */
}

/* Inside the console, allow children to shrink instead of overgrowing */
#works-console .wc-frame{
  min-height: 0;
  height: 100%;    /* fill only the allocated grid row */
}

/* The scrollable output remains the only scroller */
#works-console .wc-output{
  flex: 1 1 auto;
  min-height: 0;   /* ensures the internal scroller wins */
  overflow: auto;
}
/* Split container (middle only) */
#works-console .wc-split{
   display: grid;
   /* keep total width ≤ 100%: first column gets the leftover space */
   grid-template-columns:
     minmax(0, calc(100% - var(--pdfW, 0px) - var(--g)))
     minmax(0, var(--pdfW, 0px));
   gap: var(--g);
   align-items: stretch;
min-height: 0;    
   padding-right: max(var(--edge-pad), env(safe-area-inset-right));
   box-sizing: border-box;
 }


/* Animate via CSS vars (works across modern engines) */
#works-console{
   --pdfW: 0px;                 /* closed */
   --pdfTrans: 10px;
   --pdfOpacity: 0;
   --edge-pad: clamp(10px, 1.6vw, 18px);  /* right inset for PDF column */
--g: clamp(8px, 1.2vw, 14px);          /* unified grid gap token */
 }
#works-console.has-pdf{
   /* target PDF width; overall grid will compute leftover for col 1 */
   --pdfW: clamp(320px, 44vw, 720px);
   --pdfTrans: 0px;
   --pdfOpacity: 1;
 }

/* Pane itself animates width + slide + fade */
#works-console .wc-pdfpane{
  width: var(--pdfW);
  max-width: var(--pdfW);
  transform: translateX(var(--pdfTrans));
  opacity: var(--pdfOpacity);
  pointer-events: var(--pdfPanePE, none);
  border: 1px solid var(--border-ctl);
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 30px 80px rgba(0,0,0,.12);
  overflow: hidden;
  transition:
    width .28s cubic-bezier(.28,.01,.2,1),
    max-width .28s cubic-bezier(.28,.01,.2,1),
    transform .28s cubic-bezier(.28,.01,.2,1),
    opacity .24s ease;
}
#works-console.has-pdf .wc-pdfpane{
  --pdfPanePE: auto;
}

/* Top bar and iframe unchanged, but ensure the iframe fills */
#works-console .wc-pdfbar{
  display:flex; align-items:center; gap:10px;
flex:0 0 auto; 
  padding:8px 10px; border-bottom:1px solid var(--border-ctl);
  background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
  font-family:'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
}
#works-console .wc-pdf-frame{
  display:block; width:100%;
  flex:1 1 auto;                         /* fill remaining height */
  min-height:0;                          /* required for flex children */
  height:100% !important;                /* override any calc() leftovers */
  border:0; background:#fff;
}

/* Mobile: overlay the pane on top of the console, still only in middle */
@media (max-width: 900px){
  #works-console .wc-split{ position: relative; }
  #works-console .wc-pdfpane{
    position: absolute; inset: 0 0 0 auto;
    width: min(92vw, 720px);
    max-width: min(92vw, 720px);
    border-left: 1px solid var(--border-ctl);
    border-top-left-radius: 6px; border-bottom-left-radius: 6px;
    box-shadow: -24px 0 60px rgba(0,0,0,.18);
  }
}

</style>
<style id="wc-mobile-fixes">
/* ===== Mobile usability overrides (no desktop regressions) ===== */
@media (max-width: 900px){
  /* Let the PAGE scroll on mobile (was locked). */
  html, body{
    height:auto !important;
    min-height:100% !important;
    overflow:auto !important;
  }

  /* Drop one-page hard fit; allow natural height. */
  #works-group.wc-group{
    height:auto !important;
    min-height:100svh !important; /* fallback-safe for iOS */
    grid-template-rows:auto auto auto !important;
  }

  /* Console can size naturally; child scroller remains smooth. */
  #works-console{
    min-height:auto !important;
  }
  #works-console .wc-frame{
    height:auto !important;
    max-height:none !important;
  }

  /* Smooth, momentum scrolling inside the log on iOS. */
  #works-console .wc-output{
    max-height:none !important;
    -webkit-overflow-scrolling: touch;
  }

  /* Keep HUD from covering the input on small screens. */
  #works-console .wc-hud{
    position:static !important;
    margin-top:8px !important;
  }

  /* Give the input some breathing room above the iOS home bar. */
  #works-console .wc-input{
    padding-bottom: max(14px, env(safe-area-inset-bottom)) !important;
  }
}

/* Prefer dynamic viewport when supported, still scoped to mobile. */
@supports (height: 100dvh){
  @media (max-width: 900px){
    #works-group.wc-group{ min-height:100dvh !important; }
  }
}
</style>
<style id="wc-mobile-fit-shadow">
/* Phone fixes: 1) pane fits fully in viewport, 2) overlay/shadow goes full-bleed */
@media (max-width: 900px){
  /* 1) Make the PDF pane fit cleanly inside the viewport (no right clip). */
  #works-console .wc-pdfpane{
    position: absolute;                 /* keep it scoped to the middle section */
    left: max(6px, env(safe-area-inset-left)) !important;
    right: max(6px, env(safe-area-inset-right)) !important;
    width: auto !important;             /* fill between left/right */
    max-width: none !important;
    transform: none !important;         /* remove the 6% slide that caused clipping */
  }

  /* Let shadows bleed past the group's padding on mobile. */
  #works-group.wc-group{
    overflow: visible !important;
  }

  /* 2) Full-bleed background/shadow while the PDF pane is open. */
  #works-console.has-pdf::before{
    content: "";
    position: fixed;                    /* extend to viewport edges (beyond the group inset) */
    inset: 0;
    pointer-events: none;
    z-index: 0;
    /* soft edge darkening; tweak strength if desired */
    background: radial-gradient(120% 100% at 50% 10%,
                 rgba(0,0,0,.20), rgba(0,0,0,.12) 35%, transparent 65%);
  }
  #works-console .wc-split{ position: relative; z-index: 1; }
}
</style>
<style id="wc-theme-maps">
/* Global hint for native controls */
#works-group{ color-scheme: light dark; }

/* ——— Toggle button ——— */
#wc-theme-toggle.wc-theme{
  position:absolute; top: max(8px, calc(env(safe-area-inset-top) + 4px));
  right:max(8px, calc(env(safe-area-inset-right) + 4px));
  z-index:2;
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:10px;
  padding:0; cursor:pointer;
  transition: transform .12s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
}
#wc-theme-toggle.wc-theme:active{ transform: translateY(0); }
#wc-theme-toggle .wc-theme-ico{ display:block; }

/* Dark look for toggle */
#works-group[data-theme="dark"] #wc-theme-toggle{
  background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  border:1px solid var(--border-ctl);
  color:#0f0f0f;
  box-shadow: inset 0 1px rgba(255,255,255,.6);
}
#works-group[data-theme="dark"] #wc-theme-toggle:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(0,0,0,.24); }
/* Light look for toggle */
#works-group[data-theme="light"] #wc-theme-toggle{
  background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  border:1px solid var(--border-ctl);
  color:#0f0f0f;
  box-shadow: inset 0 1px rgba(255,255,255,.6);
}
#works-group[data-theme="light"] #wc-theme-toggle:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(0,0,0,.24); }

/* ——— THEME TOKEN MAPS ——— */
/* Dark (current AeroShell defaults) */
#works-group[data-theme="dark"] #works-console{
  --fg:#f3f4f6; --muted:#c7c8ce; --dim:#9aa1a9;
  --warn:#fbbf24; --err:#ef4444; --ok:#22c55e;
  --accent:#ffffff;
  --aero-bg:rgba(0,0,0,.9);
  --aero-stroke:rgba(255,255,255,.02);
  --aero-blur:14px;
  --aero-shadow:0 30px 80px rgba(0,0,0,.55);
  --aero-glow:0 0 0 1px rgba(255,255,255,.05);
  --line:rgba(255,255,255,.08);
  --chip-bg:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  --chip-bd:rgba(255,255,255,.16);
  --chip-bg-h:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025));
  --chip-ring:rgba(245,245,245,.38);
--btn-fg:#ffffff;
}

/* Light (paper) */
#works-group[data-theme="light"] #works-console{
--border-ctl: rgba(0,0,0,.22);       /* default border = dark gray/black */
 --border-hover: rgba(255,25,25,.55); /* hover accent = red */
  --fg:#0f172a; --muted:#334155; --dim:#475569;
  --warn:#b45309; --err:#b91c1c; --ok:#15803d;
  --accent:#0f0f0f;
  --aero-bg:rgba(255,255,255,.88);
  --aero-stroke:rgba(0,0,0,.06);
  --aero-blur:6px;
  --aero-shadow:0 30px 80px rgba(0,0,0,.12);
  --aero-glow:0 0 0 1px rgba(0,0,0,.04);
  --line:rgba(0,0,0,.10);
  --chip-bg:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  --chip-bd: var(--border-ctl);        /* chips/buttons follow spec */
  --chip-bg-h:linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.02));
  --chip-ring:rgba(0,0,0,.28);
--btn-fg:#0f0f0f;
}

/* Titlebar + breadcrumbs color overrides for DARK (light already covered by existing rules) */
#works-group[data-theme="dark"] .wc-titlebar .wt-wrap{ color:#000000 !important; }
#works-group[data-theme="dark"] .wc-titlebar .wt-title{ color:#000000 !important; }
#works-group[data-theme="dark"] .wc-titlebar .wt-subtitle{ color:#000000 !important; }
#works-group[data-theme="dark"] .wc-titlebar .wt-updated{
  border-color:rgba(0,0,0,.12) !important;
  background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015)) !important;
  color:#000000 !important;
}

/* Breadcrumbs + chips */
#works-group[data-theme="dark"] .wc-crumbs{ color:#0f0f0f; }
#works-group[data-theme="dark"] .wc-crumbs .wb-micro{ color:#0f0f0f; opacity:.65; }
#works-group .wc-crumbs .wb-actions .wb-chip{
  border:1px solid var(--border-ctl);
  background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  color:#0f0f0f;
}
#works-group[data-theme="dark"] .wc-crumbs .wb-chip::after{
  background:linear-gradient(90deg, rgba(0,0,0,.7), rgba(0,0,0,.35));
}
#works-group[data-theme="dark"] .wc-crumbs .wb-orbit g{ stroke:#0f0f0f !important; }

/* PDF split-pane chrome themes */
#works-group[data-theme="dark"] #works-console .wc-pdfpane{
  border-color: rgba(255,255,255,.12);
  background: #0b0b0b;
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
}
#works-group[data-theme="dark"] #works-console .wc-pdfbar{
  border-bottom:1px solid rgba(255,255,255,.12);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#works-group[data-theme="dark"] #works-console .wc-pdf-title{ color:#f3f4f6; opacity:.85; }
#works-group[data-theme="dark"] #works-console .wc-pdf-close{
  border:1px solid rgba(255,255,255,.18);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  color:#fff;
}

/* Respect reduced motion for icon flourish (none used beyond existing) */
@media (prefers-reduced-motion: reduce){
  #wc-theme-toggle{ transition:none !important; }
}
#works-console{ color-scheme: light dark; }
/* Light theme: console title reads as black on light surfaces */
#works-group[data-theme="light"] #works-console{ --title-fg:#0f0f0f; }
/* === THEME MAPS (no Auto) === */

#works-group[data-theme="light"] #works-console{
--border-ctl: rgba(0,0,0,.22);
 --border-hover: rgba(255,25,25,.55); /* red only on hover */
  --fg:#0f172a; --muted:#475569; --dim:#64748b;
  --warn:#b45309; --err:#b91c1c; --ok:#166534;
  --accent:#0f0f0f;
  --aero-bg:rgba(255,255,255,.96);
  --aero-stroke:rgba(0,0,0,.10);
  --aero-shadow:0 20px 60px rgba(0,0,0,.12);
  --aero-glow:0 0 0 1px rgba(0,0,0,.03);
  --line:rgba(0,0,0,.12);
  --chip-bg:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  --chip-bd: var(--border-ctl);        /* ← red in light */
  --chip-bg-h:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02));
  --chip-ring:rgba(0,0,0,.28);
  --title-fg:#0f0f0f;
}
#works-group[data-theme="dark"] #works-console{
--border-hover: var(--border-ctl);
--border-ctl: rgba(255,255,255,.55); /* ← dark mode border color */
  /* keep your existing dark tokens, but make sure title remains readable per your pec */
 --title-fg:#fff; /* (if you want black in dark, change to #0f0f0f) */
  --chip-bd: var(--border-ctl);        /* chips/buttons follow spec */
}

/* Title bar badge should look the same in both themes (per spec) */
#works-group .wc-titlebar .wt-updated{
  border-color: var(--border-ctl) !important;
  background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.015));
  color:#0f0f0f;
}

/* Footer stays visible in both themes */
#works-group[data-theme="dark"] .wc-crumbs,
#works-group[data-theme="dark"] .wc-crumbs .wb-micro,
#works-group[data-theme="dark"] .wc-crumbs .wb-chip{ color:#0f0f0f; }
/* ===== Size preset: Large ===== */
#works-group[data-size="lg"]{
  /* a bit more outer breathing room */
  padding: clamp(12px, 2vw, 24px);
}

/* widen all primary wrappers */
#works-group[data-size="lg"] .wc-titlebar .wt-wrap,
#works-group[data-size="lg"] #works-console .wc-frame,
#works-group[data-size="lg"] .wc-crumbs .wb-wrap{
  max-width: 1280px;
}

/* bump global console type slightly */
#works-group[data-size="lg"] #works-console{
  font-size: 16px;
}

/* title/subtitle scale (keeps your IBM Plex Mono) */
#works-group[data-size="lg"] .wc-titlebar .wt-title{
  font-size: clamp(20px, 2.4vw, 30px);
}
#works-group[data-size="lg"] .wc-titlebar .wt-subtitle{
  font-size: clamp(12px, 1.3vw, 16px);
}

/* console frame: a touch taller */
#works-group[data-size="lg"] #works-console .wc-split{
  height: clamp(620px, 74vh, 1400px) !important;
}

/* PDF split width a bit roomier */
#works-group[data-size="lg"] #works-console.has-pdf{
  --pdfW: clamp(360px, 50vw, 860px);
}
/* === Fix: keep theme toggle pinned to top-right, independent of title width === */
#works-group #wc-theme-toggle {
  position: fixed !important;
  top: max(8px, calc(env(safe-area-inset-top) + 6px)) !important;
  right: max(8px, calc(env(safe-area-inset-right) + 6px)) !important;
  z-index: 1000 !important;
}
.wc-crumbs .wb-brand{
  display:flex;
  flex-direction:row;      /* one line */
  align-items:center;      /* vertical align */
  gap:8px;                 /* space between aperture and badge */
  white-space:nowrap;      /* prevent wrapping */
}
.wc-crumbs .wb-badge{ line-height:0; }   /* remove inline-gap */
.wc-crumbs .wb-badge img{
  display:block;
  height:18px;                 /* compact, matches icon scale */
}
@media (max-width: 600px){
  .wc-crumbs .wb-badge img{ height:16px; }
}

</style>
